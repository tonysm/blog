<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="lang">
  <head>
    <title data-vue-tag="true">Integrating Elasticsearch with Your Laravel app - Tony Messias</title><meta data-vue-tag="true" charset="utf-8"/><meta data-vue-tag="true" name="generator" content="Gridsome v0.5.4"/><meta data-vue-tag="true" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><meta data-vue-tag="true" data-key="description" name="description" content="Personal blog about Software Engineering and Programming."/><meta data-vue-tag="true" data-key="format-detection" name="format-detection" content="telephone=no"/><meta data-vue-tag="true" name="description" content="Integrating Elasticsearch with your Laravel app"/><link data-vue-tag="true" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9bb7ffa.png"/><link data-vue-tag="true" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9bb7ffa.png"/><link data-vue-tag="true" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9bb7ffa.png"/><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9bb7ffa.png"/><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9bb7ffa.png"/><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9bb7ffa.png"/><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9bb7ffa.png"/><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9bb7ffa.png"/><noscript data-vue-tag="true" ><style>.g-image--loading{display:none;}</style></noscript><link rel="preload" href="/assets/css/styles.a78cf7ad.css" as="style"><link rel="preload" href="/assets/js/app.548f02cd.js" as="script"><link rel="preload" href="/assets/css/3.styles.3f1a7a3c.css" as="style"><link rel="preload" href="/assets/js/component--post.ffd855bb.js" as="script"><link rel="prefetch" href="/assets/js/component--404.6d16f789.js"><link rel="prefetch" href="/assets/js/component--home.d3a15305.js"><link rel="prefetch" href="/assets/js/component--tag.5caee10c.js"><link rel="prefetch" href="/assets/js/page-query.32f9b40d.js"><link rel="stylesheet" href="/assets/css/styles.a78cf7ad.css"><link rel="stylesheet" href="/assets/css/3.styles.3f1a7a3c.css">
  </head>
  <body data-vue-tag="">
    <script>
      // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
      (function() {
        window.__onThemeChange = function() {};
        function setTheme(newTheme) {
          window.__theme = newTheme;
          preferredTheme = newTheme;
          document.body.setAttribute('data-theme', newTheme);
          window.__onThemeChange(newTheme);
        }

        var preferredTheme;
        try {
          preferredTheme = localStorage.getItem('theme');
        } catch (err) { }

        window.__setPreferredTheme = function(newTheme) {
          setTheme(newTheme);
          try {
            localStorage.setItem('theme', newTheme);
          } catch (err) {}
        }

        var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkQuery.addListener(function(e) {
          window.__setPreferredTheme(e.matches ? 'dark' : 'light')
        });

        setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
      })();
    </script>

    <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/" class="logo active"><span class="logo__text">
    ‚Üê Tony Messias
  </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">
      Integrating Elasticsearch with Your Laravel app
    </h1><div class="post-meta">
   Posted 2. January 2015.
   <strong>6 min read.</strong></div></div><div class="post content-box"><div class="post__header"><!----></div><div class="post__content"><p>Searching is an important part of many applications, and it is most of the time treated as a simple task. "Just query using LIKE and you're good to go". Well, while the LIKE clause can be handy sometimes we have to do it in a better way. After researching for a while I found a few good resources on the subject. The most attractive one is Elasticsearch. Yes, you can go far with full-text search and other searching techniques, however Elasticsearch is very handy and comes with a variety of
useful functionalities. I'm going to cover the basics here and link more resources at the bottom, so you can dig further.</p>
<h2 id="what-is-elasticsearch"><a href="#what-is-elasticsearch" aria-hidden="true"><span class="icon icon-link"></span></a>What is Elasticsearch?</h2>
<p>From the <a href="http://www.elasticsearch.org/overview/" target="_blank" rel="nofollow noopener noreferrer">website</a>:</p>
<blockquote>
<p>Elasticsearch is a flexible and powerful open source, distributed, real-time search and analytics engine. Architected from the ground up for use in distributed environments where reliability and scalability are must haves, Elasticsearch gives you the ability to move easily beyond simple full-text search. Through its robust set of APIs and query DSLs, plus clients for the most popular programming languages, Elasticsearch delivers on the near limitless promises of search technology.</p>
</blockquote>
<p>In other words: you can use Elasticsearch for logging (see the <a href="http://www.elasticsearch.org/webinars/introduction-elk-stack/" target="_blank" rel="nofollow noopener noreferrer">ELK stack</a>) and for searching. This article aims to explain the usage for searching, maybe I'll cover the logging and analytics in another article.</p>
<h2 id="basics-about-elasticsearch-with-a-sql-comparison"><a href="#basics-about-elasticsearch-with-a-sql-comparison" aria-hidden="true"><span class="icon icon-link"></span></a>Basics about Elasticsearch (with a SQL comparison)</h2>
<p>So, in SQL we have a database with tables, which is like the structure of the data, and rows, which are the data itself (basically the values for the table structure). Translating this knowledge to Elasticsearch we have: indexes (like the database itself or schemas in some DBMS) and inside the indexes, we have types (like a database table) and we also have documents (like the database rows), which is the data itself.</p>
<p>Elasticsearch is schema free. However, it is not schema-less, 'cause in order to have better query results, we have to use schemas to make the searches relevant.</p>
<h2 id="integration-with-laravel"><a href="#integration-with-laravel" aria-hidden="true"><span class="icon icon-link"></span></a>Integration with Laravel</h2>
<p>Well, the concepts shown here I took from a Laracon Talk linked at the bottom. It is using Laravel, but the concepts apply to any language/framework because Elasticsearch works as a RESTful API, it means that you consume it using HTTP requests. Don't worry, Elasticsearch is pretty fast and easily scalable.</p>
<p>First thing to know is that you have to have DATA to use elasticsearch, so in my example I have a seed command that populates the database and, while it does that, it indexes all of the data on Elasticsearch. I'll show it in a while, first let's see how we can integrate it with our Eloquent usage.</p>
<p>The way I'll show you is by using <a href="http://laravel.com/docs/4.2/eloquent#model-observers" target="_blank" rel="nofollow noopener noreferrer">Model Observers</a>, so you have a refular Eloquent Model, let's say <code>Article</code>. Then you have a Observer like so:</p>
<pre class="language-php">// app/Observers/ElasticsearchArticleObserver.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Observers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Article</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Elasticsearch<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ElasticsearchArticleObserver</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$elasticsearch</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>Client <span class="token variable">$elasticsearch</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">elasticsearch</span> <span class="token operator">=</span> <span class="token variable">$elasticsearch</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">created</span><span class="token punctuation">(</span>Article <span class="token variable">$article</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">elasticsearch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'index'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'acme'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'articles'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'id'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'body'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">updated</span><span class="token punctuation">(</span>Article <span class="token variable">$article</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">elasticsearch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'index'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'acme'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'articles'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'id'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'body'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">deleted</span><span class="token punctuation">(</span>Article <span class="token variable">$article</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">elasticsearch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'index'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'acme'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'articles'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'id'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></pre>
<p>We can register our Observer using a ServiceProvider, like so:</p>
<pre class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Providers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Observers<span class="token punctuation">\</span>ElasticsearchArticleObserver</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Article</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Elasticsearch<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>ServiceProvider</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ObserversServiceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceProvider</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token scope">Article<span class="token punctuation">::</span></span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">app</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">make</span><span class="token punctuation">(</span><span class="token scope">ElasticsearchArticleObserver<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">app</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bindShared</span><span class="token punctuation">(</span><span class="token scope">ElasticsearchArticleObserver<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchArticleObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></pre>
<p>Remember to register the Service Provider on your <code>config/app.php</code> file.</p>
<p>Now, whenever we create, update or delete an entity using our Eloquent Article Model, we trigger the Elasticsearch Observer to update its data.
Worth noting that this happens synchronously during the Request. A better way is to use Domain Events and have a Elasticsearch handler that updates it in background to speed up the user request.</p>
<h2 id="searching-with-repositories"><a href="#searching-with-repositories" aria-hidden="true"><span class="icon icon-link"></span></a>Searching with Repositories</h2>
<p>Now that you have your elasticsearch fed with your application data, you can perform a better search experience. Let's assume you already have a repository that makes the search using LIKE clause or some full-text search functions. Well, you can still have that as a backup in case your elasticsearch servers crash, in order to do so, you just <em>decorate</em> your Repository. Let's see how we could do that, first you need to extract an interface of your repository, in case you don't already have
one:</p>
<pre class="language-php">// app/Articles/ArticlesRepository.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Articles</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Collection</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ArticlesRepository</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * @param string $query = ""
     * @return Collection
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @return Collection
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></pre>
<p>Then your Eloquent repository should implement it like so:</p>
<pre class="language-php">// app/Articles/EloquentArticlesRepository.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Articles</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Article</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EloquentArticlesRepository</span> <span class="token keyword">implements</span> <span class="token class-name">ArticlesRepository</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * {@inheritdoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token scope">Article<span class="token punctuation">::</span></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'body'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'like'</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"%<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$query</span><span class="token punctuation">}</span></span>%"</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">></span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'like'</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"%<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$query</span><span class="token punctuation">}</span></span>%"</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * {@inheritdoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token scope">Article<span class="token punctuation">::</span></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></pre>
<p>Now, you can write the ElasticseachArticleRepository as a decorator, like so:</p>
<pre class="language-php">// app/Articles/ElasticsearchArticlesRepository
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Articles</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Collection</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Article</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Elasticsearch<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ElasticsearchArticlesRepository</span> <span class="token keyword">implements</span> <span class="token class-name">ArticlesRepository</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$elasticsearch</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$innerRepository</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>Client <span class="token variable">$client</span><span class="token punctuation">,</span> ArticlesRepository <span class="token variable">$innerRepository</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">elasticsearch</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token punctuation">;</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">innerRepository</span> <span class="token operator">=</span> <span class="token variable">$innerRepository</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param string $query = ""
     * @return Collection
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token double-quoted-string string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$items</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">searchOnElasticsearch</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">buildCollection</span><span class="token punctuation">(</span><span class="token variable">$items</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return Collection
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">innerRepository</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param string $query
     * @result array
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">searchOnElasticsearch</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$items</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">elasticsearch</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'index'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'acme'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'articles'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'body'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'query'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>
                    <span class="token single-quoted-string string">'query_string'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>
                        <span class="token single-quoted-string string">'query'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$query</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$items</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param array $items the elasticsearch result
     * @return Collection of Eloquent models
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">buildCollection</span><span class="token punctuation">(</span><span class="token variable">$items</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$items</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'hits'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token scope">Collection<span class="token punctuation">::</span></span><span class="token function">make</span><span class="token punctuation">(</span><span class="token function">array_map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$article</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Article</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'_source'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setRawAttributes</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'_source'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$article</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></pre>
<p>Now, the trick is to decorate your repository on your Service Provider, like so:</p>
<pre class="language-php">// app/Providers/RepositoriesServiceProvider.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Providers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Articles<span class="token punctuation">\</span>ElasticsearchArticlesRepository</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Articles<span class="token punctuation">\</span>EloquentArticlesRepository</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Articles<span class="token punctuation">\</span>ArticlesRepository</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Elasticsearch<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>ServiceProvider</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RepositoriesServiceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceProvider</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * {@inheritdoc}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">app</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bindShared</span><span class="token punctuation">(</span><span class="token scope">ArticlesRepository<span class="token punctuation">::</span></span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$app</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchArticlesRepository</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">EloquentArticlesRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></pre>
<p>Now, everywhere you depend on ArticlesRepository interface, you will actually have a ElasticsearchArticlesRepository.</p>
<h2 id="conclusion"><a href="#conclusion" aria-hidden="true"><span class="icon icon-link"></span></a>Conclusion</h2>
<p>The post is getting too long, so maybe I will do another one about quering and filtering on Elasticsearch. Worth saying that every example class here is easily testable, just mock the Elasticsearch\Client and you are good to go. To finish up, here is the seeder, so after setting up as above, just run the <code>php artisan db:seed</code> command to populate your database and elasticsearch:</p>
<pre class="language-php">// database/seeds/ArticlesTableSeeder.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name">ArticlesTableSeeder</span> <span class="token keyword">extends</span> <span class="token class-name">Seeder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token scope">Laracasts<span class="token punctuation">\</span>TestDummy<span class="token punctuation">\</span>Factory<span class="token punctuation">::</span></span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Article'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> </span></pre>
<p>I'm using TestDummy here, so you better check the package to have an understanding of what is going on here. It is also easy to do a cli command to reindex your elasticsearch, like so:</p>
<pre class="language-php">// app/Console/IndexArticlesToElasticsearchCommand.php
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Console</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Article</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Elasticsearch<span class="token punctuation">\</span>Client</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">IndexArticlesToElasticsearchCommand</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * {@inheritdoc}
     */</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"app:es-index"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * {@inheritdoc}
     */</span>
    <span class="token keyword">protected</span> <span class="token variable">$description</span> <span class="token operator">=</span> <span class="token double-quoted-string string">"Indexes all articles to elasticsearch"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @return void
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$models</span> <span class="token operator">=</span> <span class="token scope">Article<span class="token punctuation">::</span></span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$es</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$models</span> <span class="token keyword">as</span> <span class="token variable">$model</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$es</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'index'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'acme'</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'articles'</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'id'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$model</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'body'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$model</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></pre>
<p>After registering your command, you can run <code>php artisan app:es-index</code> to index existing articles to Elasticsearch.</p>
<h2 id="useful-resources"><a href="#useful-resources" aria-hidden="true"><span class="icon icon-link"></span></a>Useful Resources</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=waTWeJeFp4A" target="_blank" rel="nofollow noopener noreferrer">LaraconEU talk about Elasticsearch by Ben Corlett</a></li>
<li><a href="https://www.youtube.com/watch?v=7FLXjgB0PQI" target="_blank" rel="nofollow noopener noreferrer">Getting Down and Dirty with ElasticSearch by Clinton Gormley</a></li>
<li><a href="http://laravel.com/docs/4.2/eloquent#model-observers" target="_blank" rel="nofollow noopener noreferrer">Laravel Model Observers</a></li>
<li><a href="https://github.com/tonysm/laravel-elasticsearch-test" target="_blank" rel="nofollow noopener noreferrer">My demo project on Github</a></li>
<li><a href="https://www.youtube.com/watch?v=GrdzX9BNfkg" target="_blank" rel="nofollow noopener noreferrer">Introduction and Demo to the Elasticsearch, Logstash and Kibana</a></li>
</ul>
</div><div class="post__footer"><div class="post-tags"></div></div></div><div class="post-comments"></div><div class="author post-author"><img alt="Author image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-73'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='5'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-73)' width='180' height='180' xlink:href='data:image/jpeg%3bbase64%2c/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABAAEADASIAAhEBAxEB/8QAHAAAAgEFAQAAAAAAAAAAAAAABgcAAQIDBQgE/8QANBAAAQMDAgMHAQYHAAAAAAAAAQIDBAAFEQYSByExEyJBUWFxkRUIFDJCgaEWI1KxweHx/8QAGQEAAwEBAQAAAAAAAAAAAAAAAAEDAgQF/8QAHREAAgMAAwEBAAAAAAAAAAAAAAECAxEEEiExQf/aAAwDAQACEQMRAD8A6kqmatKqoVUAee6XOFaoipVyktRmE9VuKwP90qrvx2s0VahDhOyEbiELUvbvA/NtAJA8s86XH2iNVPXTVrljY7sS3kJVg/jcIBJ/TOPmtPw%2b4ejUEVUy5PqajJVtS03gLV6k%2bApSaitZSuDk8SG1YePNolrUm6QXYgz3S0vtOXqMCmvY7vDvltan213tYzmQFEEHIOCCK51vnB%2bImG47Zp0huQBlKHiFJPpkYIog%2bzlcLkm5XSzyi8I0ZkLKFK3IC9%2bMjyzzpRkn8NTqcV6h81Kpmq1oiYCedWk1DVtAHOfELQ82RxFvl0aQ0phbrTjba1YKypCckeHXz8aIrG6q3adTISysPLBKkkeXIDAos4kW51MqHc20KXGyGZIHPsyDltzB5YBO0%2b4PhSntOsF2rUUy1XgZSmUQ2sdEhXMfpULFJ6j0KJVqKYUac1PdZd3RBuNvT92WkntexW2QfDqT%2b%2bKKeEMNlU/UV2RAVDckPoZ2kk5CQTkZA6kgnGedBN61RPmXgxLDZpkwRllt0oTtSpX9W7qQOfpR5wl1H9c%2boIVGVGW2oEtlQV05ZyOuT0Pp6Uq97D5HV1vGMcGq5qgqV0HnGI1Yail4FD2qdWWjTMbtbtLShah3GEd5xfsn/JwKYjdy0IXFeS6ApsoUFA9CMHNcs8UdPyPqbd1tzDjiXGgXtvmB1%2bKMYfFj%2bINSri3B/wCk2laSIwCsBas4/nL9ug5Cj1i3NS4vZpIcaI5KQcgj3FTnqkdFSTg/RMM8SbeiwJYjRFxp7bQQydgWhKvPz5%2bXrTw4TRVKsjl4kw1RZVxKCULb2ENoTtT3fAE7lY9RQtdLNo3SiF3G5xoLT%2bMpSUAuKI8EI8/WgrS/Fu72h1aXGxMtpcPZx5CyVtJJJADnX5zRCC/EF1rxKTOmxUoJ0txJ0/f9raJBhyjy7GThOT5BXQ0aBWehzW8OdPRKcVeJcy1TpNosOxt1kBL0o95SVHqlI6DHmaRMyW/NnrekOqedKVKWtZJJPmSa9V3kOLujj7yytTqsuE/myeZ%2beda2LlSnj4kL%2bAcf3P7VXMI9m/SbAtGMAgDpWSM9IipxGkyY6ScbWnlJHwDW8f08tqw2udHeD4mqLZSE4KHAfw%2btb%2b46TstuZdXKk3hSYi0tyHWY6FNpWQDtzn1qUroLCsapsAFHe7vcKnHD1WtRUo/qayjm04getGzOnbMH21CJe321R1SgVraaBaHVQ656jl1q%2b8aet0O1Pvx4k1D6QklLsttSmgo8t6Bz5ikuRFtJDdEktYFBwtqkuA7ShsLHucU6%2bC%2bsJLVwRabjIW5EkJSWAtWeyUcYGfI5xj2pLz2cNnHVyOpPvj/lbzSa98rkshRbPeB5glR2/ASKu1vhDc9P/9k=' /%3e%3c/svg%3e" width="180" data-src="/assets/static/author.e6b6009.2e099e8.jpg" data-srcset="/assets/static/author.e6b6009.2e099e8.jpg 180w" data-sizes="(max-width: 180px) 100vw, 180px" class="author__image g-image g-image--lazy g-image--loading"><noscript><img src="/assets/static/author.e6b6009.2e099e8.jpg" class="author__image g-image g-image--loaded" width="180"></noscript><!----><p class="author__intro">
            My name is <a href="//twitter.com/tony0x01">Tony Messias</a>. I'm a <a href="//madewithlove.be" title="I work here. Looking for a job? Check us out.">Software Engineer</a>. This is my personal blog where I share thoughts and experiments on programming.
		</p><p class="author__links"><a href="//github.com/tonysm" title="This is my GitHub - where I share experimental repositories. You can check it out.">GitHub</a><a href="//www.meetup.com/pt-BR/maceio-dev-meetup/" title="I co-organize a meetup in my Macei√≥/AL (Brazil), if you are nearby, come join us!">Macei√≥ DEV Meetup</a><a href="//www.youtube.com/channel/UCGtfJjAR5JeBPAmxN_ZHx4Q?view_as=subscriber" title="I often share screencasts on YouTube">Screencasts</a></p></div></main><footer class="footer"><span class="footer__copyright">Copyright ¬© 2019. </span><span class="footer__links">Powered by <a href="//gridsome.org"> Gridsome </a></span></footer></div>
    <script src="/assets/js/app.548f02cd.js" defer></script><script src="/assets/js/component--post.ffd855bb.js" defer></script>
  </body>
</html>